#For Checking Email
import email
import imaplib
import mailbox
import re

#Declaring globals
EMAIL_ACCOUNT = "MailID" #User's email (Mails will be checked for this ID)
PASSWORD = "Password" #User's Password

#LOGIN AND GATHER ALL MAILS
mail = imaplib.IMAP4_SSL('imap.gmail.com', 993)
mail.login(EMAIL_ACCOUNT, PASSWORD)
mail.list()
mail.select('inbox')
result, data = mail.uid('search',None, '(SUBJECT "Shutdown")', 'UNSEEN')
i = len(data[0].split())
#ITERATE THROUGH MAILS
for x in range(i):
    latest_email_uid = data[0].split()[x]
    result, email_data = mail.uid('fetch', latest_email_uid, '(RFC822)')
    raw_email = email_data[0][1]
    raw_email_string = raw_email.decode('utf-8')
    email_message = email.message_from_string(raw_email_string)
    email_from = str(email.header.make_header(email.header.decode_header(email_message['From'])))	#Fetch the sender IDs
    subject = str(email.header.make_header(email.header.decode_header(email_message['Subject'])))	#Fetch mail subjects
    print(subject)
    #Format the ID
    lst = re.findall(EMAIL_ACCOUNT, email_from)
    p = str(lst)
    r1 = p.replace(r"[","")
    r2 = r1.replace(r"]","")
    r3 = r2.replace(r"'","")
    #VALIDATING SENDER
    if r3 == EMAIL_ACCOUNT:
        if subject == "Shutdown":
            if r3 == EMAIL_ACCOUNT:
                #print(r3) #Debugging
                #DELETE THE MAIL IF FOUND TO REMOVE CLUTTER
                try:
                    typ, data = mail.search(None, 'subject',subject, 'from',EMAIL_ACCOUNT)
                    for num in data[0].split():
                        mail.store(num, '+FLAGS', '\\Deleted') #Mark for deletion
                        mail.expunge() #Delete everything marked
                        mail.close() 
                        mail.logout() #Logout
                        #mail.disconnect() # Disconnect
                        print("Would've shutdown") #Debugging
                        #os.system('shutdown /p /f')	#Shutdown Windows immediately, without warning
                #IndexError appears the first time only.
                except IndexError:
                    print("ok")
                    continue
            else:
            	typ, data = mail.search(None, 'subject',subject, 'from',EMAIL_ACCOUNT)
                for num in data[0].split():
                    mail.store(num, '-FLAGS', '\\SEEN') #Mark for deletion
                    mail.expunge() #Delete everything marked
                    mail.close()
        else:
        	typ, data = mail.search(None, 'subject',subject, 'from',EMAIL_ACCOUNT)
        	for num in data[0].split():
        		mail.store(num, '-FLAGS', '\\SEEN') #Mark for deletion
        		mail.expunge() #Delete everything marked
        		mail.close()
    else:
    	typ, data = mail.search(None, 'subject',subject, 'from',EMAIL_ACCOUNT)
    	for num in data[0].split():
    		mail.store(num, '-FLAGS', '\\SEEN') #Mark for deletion
    		mail.expunge() #Delete everything marked
    		mail.close() 


